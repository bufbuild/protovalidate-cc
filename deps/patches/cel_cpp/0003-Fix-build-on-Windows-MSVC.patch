From c7701d744a3d46b078b92f51c76265de30b5a3ed Mon Sep 17 00:00:00 2001
From: John Chadwick <jchadwick@buf.build>
Date: Fri, 21 Mar 2025 20:16:07 -0400
Subject: [PATCH 3/3] Fix build on Windows/MSVC

Some fixes+hacks+workarounds for build issues on MSVC.
---
 bazel/cel_cc_embed.cc         | 2 +-
 common/types/list_type.cc     | 2 +-
 common/types/map_type.cc      | 4 ++--
 common/types/optional_type.cc | 2 +-
 internal/json.cc              | 5 +++++
 internal/well_known_types.cc  | 5 +++++
 6 files changed, 15 insertions(+), 5 deletions(-)

diff --git a/bazel/cel_cc_embed.cc b/bazel/cel_cc_embed.cc
index a9f0aec2..80515457 100644
--- a/bazel/cel_cc_embed.cc
+++ b/bazel/cel_cc_embed.cc
@@ -34,7 +34,7 @@ namespace {
 
 std::vector<uint8_t> ReadFile(const std::string& path) {
   ABSL_CHECK(!path.empty()) << "--in is required";
-  std::ifstream file(path);
+  std::ifstream file(path, std::ifstream::binary);
   ABSL_CHECK(file.is_open()) << path;
   file.seekg(0, file.end);
   ABSL_CHECK(file.good());
diff --git a/common/types/list_type.cc b/common/types/list_type.cc
index 41a6f2f1..f4dba5e5 100644
--- a/common/types/list_type.cc
+++ b/common/types/list_type.cc
@@ -28,7 +28,7 @@ namespace common_internal {
 
 namespace {
 
-ABSL_CONST_INIT const ListTypeData kDynListTypeData;
+const ListTypeData kDynListTypeData;
 
 }  // namespace
 
diff --git a/common/types/map_type.cc b/common/types/map_type.cc
index e0c15df5..1df3b52b 100644
--- a/common/types/map_type.cc
+++ b/common/types/map_type.cc
@@ -28,11 +28,11 @@ namespace common_internal {
 
 namespace {
 
-ABSL_CONST_INIT const MapTypeData kDynDynMapTypeData = {
+const MapTypeData kDynDynMapTypeData = {
     .key_and_value = {DynType(), DynType()},
 };
 
-ABSL_CONST_INIT const MapTypeData kStringDynMapTypeData = {
+const MapTypeData kStringDynMapTypeData = {
     .key_and_value = {StringType(), DynType()},
 };
 
diff --git a/common/types/optional_type.cc b/common/types/optional_type.cc
index a37300bb..3ec51ed8 100644
--- a/common/types/optional_type.cc
+++ b/common/types/optional_type.cc
@@ -47,7 +47,7 @@ static_assert(offsetof(OptionalTypeData, parameters_size) ==
 static_assert(offsetof(OptionalTypeData, parameter) ==
               offsetof(OpaqueTypeData, parameters));
 
-ABSL_CONST_INIT const DynOptionalTypeData kDynOptionalTypeData = {
+const DynOptionalTypeData kDynOptionalTypeData = {
     .optional =
         {
             .name = OptionalType::kName,
diff --git a/internal/json.cc b/internal/json.cc
index bd261ac0..17fc4809 100644
--- a/internal/json.cc
+++ b/internal/json.cc
@@ -51,6 +51,11 @@
 #include "google/protobuf/message_lite.h"
 #include "google/protobuf/util/time_util.h"
 
+// Workaround for Windows macro conflict.
+#ifdef GetMessage
+#undef GetMessage
+#endif
+
 namespace cel::internal {
 
 namespace {
diff --git a/internal/well_known_types.cc b/internal/well_known_types.cc
index 6626172e..97b6b4ee 100644
--- a/internal/well_known_types.cc
+++ b/internal/well_known_types.cc
@@ -58,6 +58,11 @@
 #include "google/protobuf/reflection.h"
 #include "google/protobuf/util/time_util.h"
 
+// Workaround for Windows macro conflict.
+#ifdef GetMessage
+#undef GetMessage
+#endif
+
 namespace cel::well_known_types {
 
 namespace {
-- 
2.47.2

